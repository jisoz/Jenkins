pipeline {
    agent any
    environment {
        MYSQL_ROOT_PASSWORD = 'secret'
        MYSQL_DATABASE = 'todos'
        MYSQL_USER = 'root'
        MYSQL_PASSWORD = 'secret'
    }
    stages {
         stage('Checkout') {
            steps {
                git(
                    url: 'https://github.com/jisoz/Jenkins.git',
                    branch: 'main'
                )
            }
        }
        stage('Build and Test') {
            steps {
                script {
                    dockerCompose.up()
                    dockerCompose.run('app', 'yarn install')
                    dockerCompose.run('app', 'yarn test')
                }
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying application...'
                // Add your deployment steps here
            }
        }
    }
    post {
        always {
            script {
                dockerCompose.down()
            }
        }
    }
}

def dockerCompose = dockerCompose('compose.yaml')

def dockerCompose(String file) {
    return [
        up: { -> sh "docker-compose -f ${file} up -d" },
        down: { -> sh "docker-compose -f ${file} down" },
        run: { service, cmd -> sh "docker-compose -f ${file} run --rm ${service} ${cmd}" }
    ]
}
